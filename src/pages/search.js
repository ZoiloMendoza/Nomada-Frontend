import Head from 'next/head';
import NavbarTwo from '@/components/Navbar/NavbarTwo';
import SearchBar from '@/components/Search/Search';
import MapButton from '@/components/common/MapButton';
import { cityData } from '@/components/Search/cityData';
import RestaurantCard from '@/components/Search/RestaurantCard';
import { restaurantData } from '@/components/Search/restaurantData';
import Footer from '@/components/Footer/Footer';
//import Spinner from '@/components/common/Spinner';
//import axios from 'axios';
//import React, { useEffect, useState } from 'react';

import Box from '@mui/material/Box';
import CityCard from '@/components/Search/cityCard';
import axios from 'axios';

export default function Search({ contentApi = [] }) {
  console.log('getInitialProps', contentApi);

  return (
    <>
      <Head>
        <title>Nomada</title>
        <meta name='description' content='Generated by create next app' />
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='icon' href='/img/logo1.svg' />
        <link
          rel='stylesheet'
          type='text/css'
          href='https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.min.css'
        />
        <link
          rel='stylesheet'
          type='text/css'
          href='https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick-theme.min.css'
        />
      </Head>
      <NavbarTwo />

      <SearchBar />

      <Box>
        {
          /*contentApi === undefined || contentApi.lengh === 0 ? <Spinner/> :*/
          <CityCard contentApi={cityData} />
        }
      </Box>
      <Box>
        {
          /*contentApi === undefined || contentApi.lengh === 0 ? <Spinner/> :*/
          <RestaurantCard restaurantData={restaurantData.data} />
        }
      </Box>

      <Box sx={{ width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        <MapButton />
        <div>{contentApi}</div>
      </Box>

      <Footer />
    </>
  );
}

Search.getInitialProps = async () => {
  const apiKey = process.env.NEXT_PUBLIC_API_TRIPADVISOR_KEY;
  let contentApi = [];
  const latitude = '21.14967'; //se obtiene de LocationDetails
  const longitude = '-86.80287'; //se obtiene de LocationDetails
  const category = 'geos';
  const apiUrl = `https://api.content.tripadvisor.com/api/v1/location/nearby_search?latLong=${latitude}%2C${longitude}&key=${apiKey}&category=${category}&radius=60&radiusUnit=km&language=en`;
  try {
    const response = await axios.get(apiUrl);
    if (!response.data || !response.data.data) {
      res.status(500).json({ error: 'No data received from the TripAdvisor API' });
      return;
    }
    const locationData = response.data.data;
    const exampleData = await Promise.all(
      locationData.map(async (item) => {
        try {
          const responsePhoto = await axios.get(
            `https://api.content.tripadvisor.com/api/v1/location/${item.location_id}/photos?key=${apiKey}&language=en`,
          );
          return { ...item, ...responsePhoto.data };
        } catch (error) {
          console.error(`Error fetching photo for location ${item.location_id}:`, error);
          return item;
        }
      }),
    );
    res.status(200).json(exampleData);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'An error occurred while fetching data from the TripAdvisor API' });
  }

  return { contentApi };
};
